name: Tests

on:
  push: {}
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.22
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest
      - name: Run go tests with JUnit output
        run: |
          mkdir -p test-results
          gotestsum --junitfile test-results/junit.xml --format testname -- ./... -v
      - name: Generate HTML report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Go Test Results
          path: test-results/junit.xml
          reporter: java-junit
          fail-on-error: false
      - name: Create HTML report for GitHub Pages
        if: always()
        run: |
          mkdir -p public
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>server-syncer Test Results</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #24292e; border-bottom: 2px solid #0366d6; padding-bottom: 10px; }
                  h2 { color: #586069; margin-top: 30px; }
                  .summary { background: #f6f8fa; padding: 20px; border-radius: 6px; margin: 20px 0; }
                  .pass { color: #22863a; }
                  .fail { color: #cb2431; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e1e4e8; }
                  th { background: #f6f8fa; font-weight: 600; }
                  tr:hover { background: #f6f8fa; }
                  .status-pass { background: #dcffe4; color: #22863a; padding: 4px 8px; border-radius: 4px; font-weight: 500; }
                  .status-fail { background: #ffeef0; color: #cb2431; padding: 4px 8px; border-radius: 4px; font-weight: 500; }
                  .timestamp { color: #6a737d; font-size: 14px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸ§ª server-syncer Test Results</h1>
                  <p class="timestamp">Generated: <span id="timestamp"></span></p>
                  <div class="summary" id="summary"></div>
                  <h2>Test Cases</h2>
                  <table>
                      <thead>
                          <tr>
                              <th>Test Name</th>
                              <th>Package</th>
                              <th>Duration</th>
                              <th>Status</th>
                          </tr>
                      </thead>
                      <tbody id="test-results"></tbody>
                  </table>
              </div>
              <script>
                  document.getElementById('timestamp').textContent = new Date().toLocaleString();
              </script>
          </body>
          </html>
          EOF
          
          # Parse JUnit XML and generate JavaScript data
          python3 << 'PYTHON'
          import xml.etree.ElementTree as ET
          import json
          import html
          
          tree = ET.parse('test-results/junit.xml')
          root = tree.getroot()
          
          tests = []
          total = 0
          passed = 0
          failed = 0
          
          for testsuite in root.findall('.//testsuite'):
              package = testsuite.get('name', 'unknown')
              for testcase in testsuite.findall('testcase'):
                  total += 1
                  name = testcase.get('name', 'unknown')
                  time_val = testcase.get('time', '0')
                  failure = testcase.find('failure')
                  if failure is not None:
                      status = 'fail'
                      failed += 1
                  else:
                      status = 'pass'
                      passed += 1
                  tests.append({
                      'name': name,
                      'package': package,
                      'time': time_val,
                      'status': status
                  })
          
          # Generate updated HTML with embedded data
          with open('public/index.html', 'r') as f:
              content = f.read()
          
          js_data = f'''
              const testData = {json.dumps(tests)};
              const summary = {{ total: {total}, passed: {passed}, failed: {failed} }};
              
              document.getElementById('summary').innerHTML = `
                  <strong>Summary:</strong> 
                  <span class="pass">${{summary.passed}} passed</span> | 
                  <span class="fail">${{summary.failed}} failed</span> | 
                  ${{summary.total}} total
              `;
              
              const tbody = document.getElementById('test-results');
              testData.forEach(test => {{
                  const row = document.createElement('tr');
                  const statusClass = test.status === 'pass' ? 'status-pass' : 'status-fail';
                  const statusText = test.status === 'pass' ? 'âœ“ PASS' : 'âœ— FAIL';
                  row.innerHTML = `
                      <td>${{test.name}}</td>
                      <td>${{test.package}}</td>
                      <td>${{parseFloat(test.time).toFixed(3)}}s</td>
                      <td><span class="${{statusClass}}">${{statusText}}</span></td>
                  `;
                  tbody.appendChild(row);
              }});
          '''
          
          content = content.replace(
              "document.getElementById('timestamp').textContent = new Date().toLocaleString();",
              "document.getElementById('timestamp').textContent = new Date().toLocaleString();" + js_data
          )
          
          with open('public/index.html', 'w') as f:
              f.write(content)
          PYTHON
      - name: Upload test results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
      - name: Setup Pages
        uses: actions/configure-pages@v5
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        with:
          path: public/
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
